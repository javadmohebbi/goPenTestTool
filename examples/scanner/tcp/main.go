package main

import (
	"flag"
	"fmt"
	"os"
	"os/signal"
	"syscall"
	"time"

	"github.com/javadmohebbi/goPenTestTool/scanner"
)

func main() {

	// define -target flag
	target := flag.String("target", "", fmt.Sprint("Target to scan.\nExamples:\n\t1. Hostname or IP address -> 192.168.1.1 or example.local\n\t2. Multiple IPs (comma delimited) -> 192.168.1.1,192.168.1.2, ...\n\t3. IP/Mask (CIDR) -> 192.168.0.1/24"))

	// define -ports flag
	ports := flag.String("ports", "", fmt.Sprint("Target ports to scan. If not provided, all ports will be scanned.\nExamples:\n\t1. Single Port -> 22\n\t2. Multiple Ports (comma delimited) -> 80,443,22,...\n\t3. Port Range -> 1-1024"))

	// define -timeout flag
	timeout := flag.Int("timeout", 3, "Timeout(in seconds) for each port scan. The greater timeout results more accurate scan")

	// define -output flag
	output := flag.String("output", "", "Output file")

	// define -onlyopen flag
	onlyOpenPorts := flag.Bool("opens", false, fmt.Sprintf("if provided, will report only open ports not closed!\n\t** If number of ports will be more than 20, will print only open ports"))

	// define -threads flag
	conCurrentThreads := flag.Int("maxthreads", 10, fmt.Sprint("Maximum number of threads: between 5 to 8192"))

	if *conCurrentThreads < 5 && *conCurrentThreads > 8192 {
		*conCurrentThreads = 10
	}

	// define -verbose flag
	verbose := flag.Bool("verbose", false, fmt.Sprint("Use this flag if you want more info about the scan process"))

	// parse flags
	flag.Parse()

	// check if target is not empty
	if *target == "" {
		fmt.Printf("[ERROR] not enough argument!\n\t-target MUST be provided\n\n")
		flag.PrintDefaults()
		os.Exit(127)
	}

	// create new instance of TCPScanner
	tcpScanner := scanner.TCPScanner{
		Target: *target,

		TargetPorts: *ports,

		OutputPath: *output,

		JustOpenPorts: *onlyOpenPorts,

		Verbose: *verbose,

		MaxThreads: *conCurrentThreads,

		Timeout: time.Duration(int64(*timeout)),
	}

	// run tcp scan
	result := []scanner.TCPScannerResponse{}

	// capture CTRL+C
	c := make(chan os.Signal, 2)
	signal.Notify(c, os.Interrupt, syscall.SIGTERM)
	go func() {
		<-c
		fmt.Printf("\n\n\n Ctrl+C pressed in Terminal\n\n\n")
		tcpScanner.ForceStop()
		os.Exit(0)
	}()

	err := tcpScanner.Scan(&result)
	// check if scan has error
	if err != nil {
		fmt.Printf("[ERROR] %v", err)
		os.Exit(126)
	}

	tcpScanner.PrintTable()

}
